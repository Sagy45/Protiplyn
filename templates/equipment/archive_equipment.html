{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Archiv vybavení: {{ station.name }}{% endblock %}

{% block extra_head %}
  <style>
    .equipment-table th, .equipment-table td {
      padding: 4px 6px;
      font-size: 13px;
      text-align: center;
      white-space: nowrap;
    }
    /* Wrap long serials if needed */
    .equipment-table td {
      max-width: 110px;
      overflow-x: auto;
    }
    /* Highlight archive info */
    .archive-meta {
      font-size: 12px;
      color: #666;
      white-space: normal;
    }
  </style>
{% endblock %}

{% block content %}
  <h2 style="text-align:center; margin-bottom:20px;">
    Archiv vybavení: {{ station.name }}
  </h2>

  <p style="text-align:right; margin-bottom:10px;">
    <a href="{% url 'station_equipment' station.pk %}" class="btn btn-secondary">
      ← Zpět na aktivní
    </a>
  </p>

  <div class="tab-container">
    <ul class="tab-list">
      {% for section in equipment_sections %}
        <li>
          <a href="#"
             class="{% if forloop.first %}active{% endif %}"
             data-tab="tab-{{ forloop.counter }}">
            {{ section.0 }}
          </a>
        </li>
      {% endfor %}
    </ul>

    {% for section in equipment_sections %}
      <div class="tab-content {% if forloop.first %}active{% endif %}"
           id="tab-{{ forloop.counter }}">
        <h3>{{ section.0 }}</h3>

        {% if section.1 %}
          <table class="equipment-table">
            <thead>
              <tr>
                <th>Typ</th>
                <th>E číslo</th>
                <th>Sériové číslo</th>
                {% for raw, pretty in section.2 %}
                  {% if raw|slice:":4" == "rev_" %}
                    <th>{{ pretty }}</th>
                  {% endif %}
                {% endfor %}
                <th>Archivováno</th>
                <th>Archivoval</th>
                <th>Akce</th>
              </tr>
            </thead>
            <tbody>
              {% for item in section.1 %}
                <tr>
                  <td>{{ item.type }}</td>
                  <td>{{ item.e_number }}</td>
                  <td>{{ item.serial_number }}</td>
                  {% for raw, pretty in section.2 %}
                    {% if raw|slice:":4" == "rev_" %}
                      <td>
                        {% with val=item|attr:raw %}
                          {% if val %}{{ val|date:"d.m.Y" }}{% endif %}
                        {% endwith %}
                      </td>
                    {% endif %}
                  {% endfor %}
                  <td class="archive-meta">
                    {% if item.archived_at %}
                      {{ item.archived_at|date:"d.m.Y H:i" }}
                    {% else %}–{% endif %}
                  </td>
                  <td class="archive-meta">
                    {% if item.archived_by %}
                      {{ item.archived_by.get_full_name|default:item.archived_by.username }}
                    {% else %}–{% endif %}
                  </td>
                  <td>
                    <form method="post"
                          action="{% url 'equipment_restore' item.pk %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-success">
                        Obnoviť
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p style="padding:20px; text-align:center; color:#666;">
            <em>Archiv je prázdný.</em>
          </p>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const tabs     = document.querySelectorAll(".tab-list a");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach((tab, i) => {
      tab.addEventListener("click", function (e) {
        e.preventDefault();
        tabs.forEach(t => t.classList.remove("active"));
        contents.forEach(c => c.classList.remove("active"));
        this.classList.add("active");
        contents[i].classList.add("active");
      });
    });
  });
  </script>
{% endblock %}
